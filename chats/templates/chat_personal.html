{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Bali Delights - Chat</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="max-w-6xl mx-auto bg-gray-100 h-screen flex flex-col">
  <!-- Header with Back button and store info -->
  <div class="bg-white shadow p-4 flex items-center justify-between">
    <!-- Back Button that links back to the chat list -->
    <a href="{% url 'list_chats' %}" class="bg-[#C6AC8F] text-white px-4 py-2 rounded-lg hover:bg-[#A4896C]">
      Back
    </a>

    <!-- Centered Store Name and Photo -->
    <div class="flex items-center space-x-4">
      <!-- Conditional to show a placeholder if no store photo exists -->
      <img class="w-10 h-10 rounded-full" src="{{ store.photo.url if store.photo else '/static/images/default_avatar.jpg' }}" alt="{{ store.name }}" />
      <span class="font-semibold text-gray-800">{{ store.name }}</span>
    </div>
    
    <div class="w-20"></div>
  </div> 

  <!-- Chat messages area -->
  <div id="messageList" class="flex-1 p-6 overflow-y-auto">
    <!-- Messages will be dynamically loaded here via AJAX -->
  </div>

  <!-- Message input area with Send button next to text field -->
  <div class="bg-white p-4 border-t border-gray-200">
    <form id="chatForm" method="POST" class="flex space-x-4">
      {% csrf_token %}
      <!-- Text input field -->
      <input
        type="text"
        name="message"
        id="messageInput"
        placeholder="Type a message"
        class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <!-- Send button next to text field -->
      <button type="submit" class="bg-[#C6AC8F] text-white px-4 py-2 rounded-lg hover:bg-[#A4896C]">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            d="M2.94 2.94a1.5 1.5 0 012.12 0l8.49 8.49a1.5 1.5 0 010 2.12l-2.12 2.12a1.5 1.5 0 01-2.12 0L2.94 5.06a1.5 1.5 0 010-2.12zm0 8.49l3.54 3.54-3.54-3.54z"
          />
        </svg>
      </button>
    </form>
  </div>
</div>

<!-- jQuery and AJAX for real-time message updates -->
<script type="text/javascript">
    $(document).ready(function() {
      const chatId = {{ chat.id }};  // Pass the chat ID from Django context
  
      // Function to scroll to the bottom of the message list
      function scrollToBottom() {
        $('#messageList').scrollTop($('#messageList')[0].scrollHeight);
      }
  
      // Function to load messages via AJAX for a specific chat
      function loadMessages() {
        $.ajax({
          url: `/api/chats/${chatId}/messages/`,  // URL to fetch messages for the specific chat
          type: 'GET',
          success: function(response) {
            console.log('Response:', response);  // Debugging: log the response in the console
  
            // Clear the message list
            $('#messageList').empty();
  
            // Loop through the messages and dynamically append them to the message list
            $.each(response.messages, function(index, message) {
              const messageItem = `
                <div class="flex ${message.sender_is_user ? 'justify-end' : ''} mb-4">
                  <div class="p-3 rounded-lg max-w-xs ${message.sender_is_user ? 'bg-[#C6AC8F] text-white' : 'bg-[#EAE0D5] text-gray-800'}">
                    <p>${message.content}</p>
                  </div>
                </div>
              `;
              $('#messageList').append(messageItem);
            });
  
            // Scroll to the bottom after loading all messages
            scrollToBottom();
          },
          error: function(xhr, errmsg, err) {
            console.log('Error loading messages:', errmsg);  // Debugging: log any errors
          }
        });
      }
  
      // Load all messages when the page first loads
      loadMessages();
  
      // Auto-reload the message list every 1 second (1000 milliseconds)
      setInterval(function() {
        loadMessages();  // Reload the message list for the specific chat
      }, 1000);  // 1000 milliseconds = 1 second
  
      // Send message via AJAX when the form is submitted
      $('#chatForm').on('submit', function(e) {
        e.preventDefault();  // Prevent default form submission
  
        const messageInput = $('#messageInput');
        const message = messageInput.val();  // Get the message content
  
        $.ajax({
          url: `/chats/${chatId}/send/`,  // URL for sending the message
          type: 'POST',
          data: {
            'message': message,
            'csrfmiddlewaretoken': '{{ csrf_token }}'  // Include CSRF token
          },
          success: function(response) {
            if (response.success) {
              // Append the new message to the chat area
              const messageItem = `
                <div class="flex justify-end mb-4">
                  <div class="bg-[#C6AC8F] text-white p-3 rounded-lg max-w-xs">
                    <p>${response.message.content}</p>
                  </div>
                </div>
              `;
              $('#messageList').append(messageItem);
  
              // Clear the input field
              messageInput.val('');
              // Scroll to the bottom of the chat
              scrollToBottom();
            }
          },
          error: function(xhr, errmsg, err) {
            console.log('Error sending message:', errmsg);
          }
        });
      });
    });
</script>

{% endblock content %}
