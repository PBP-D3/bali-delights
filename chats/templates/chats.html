{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Bali Delights</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-4">
    <!-- Messages Header -->
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Messages</h2>

        <!-- Add Chat Button (with Circular Background) -->
        <button onclick="window.location.href='{% url 'add_chat' %}'" class="bg-secondary text-black rounded-full w-10 h-10 flex items-center justify-center focus:outline-none">
          +
        </button>
    </div>

    <!-- Search Input -->
    <div class="w-full mb-4">
        <input type="text" id="searchMessages" placeholder="Search messages"
               class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>

    <!-- Conditional Display for Chats -->
    <div id="chatList">
        <!-- This div will be dynamically populated with chats via AJAX -->
    </div>

    <!-- No Chats Message -->
    <div id="noChatsMessage" class="text-center text-gray-600 mt-8" style="display: none;">
        No chats. Start a chat with your favorite merchant!
    </div>
</div>

<!-- jQuery for AJAX -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script type="text/javascript">
  $(document).ready(function() {
    // Function to load chats via AJAX
    function loadChats(query = "") {
      $.ajax({
        url: '/api/chats/',
        type: 'GET',
        data: { search: query },
        success: function(response) {
          $('#chatList').empty();

          if (response.chats.length === 0) {
            $('#noChatsMessage').show();
          } else {
            $('#noChatsMessage').hide();
            $.each(response.chats, function(index, chat) {
              const chatItem = `
                <a href="/chat/${chat.store.id}/" class="block">
                  <div class="flex items-center justify-between bg-gray-100 p-4 rounded-lg hover:bg-gray-200 transition duration-200 ease-in-out">
                    <div class="flex items-center">
                      <img src="${chat.store.photo_url}" alt="Photo" class="w-12 h-12 rounded-full object-cover mr-4" />
                      <div class="font-semibold text-gray-800">${chat.store.name}</div>
                    </div>
                    <div class="text-sm text-gray-500">${chat.last_message_time}</div>
                  </div>
                </a>
              `;
              $('#chatList').append(chatItem);
            });
          }
        },
        error: function(xhr, errmsg, err) {
          console.log('Error loading chats:', errmsg);
        }
      });
    }

    // Load chats when the page loads
    loadChats();

    // Search function for chats
    $('#searchMessages').on('keyup', function() {
      const query = $(this).val();
      loadChats(query);
    });
  });
</script>

{% endblock content %}
