{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Bali Delights - Chat</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-4">
    <!-- Messages Header -->
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Messages</h2>
        <button onclick="openAddChatModal()" class="bg-secondary text-black rounded-full w-10 h-10 flex items-center justify-center">+</button>
    </div>

    <!-- Search Input -->
    <div class="w-full mb-4">
        <input type="text" id="searchMessages" placeholder="Search messages" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>

    <!-- Chat List Container -->
    <div id="chatList">
        {% for chat in chats %}
        <div class="chat-item block bg-gray-100 p-4 rounded-lg mb-2 hover:bg-gray-200 cursor-pointer" data-chat-id="{{ chat.store.id }}" oncontextmenu="showDeleteOption(event, {{ chat.store.id }})" ontouchstart="startLongPress(event, {{ chat.store.id }})">
            <a href="{% url 'chat_with_store' chat.store.id %}">
                <div class="flex items-center space-x-3">
                    <img src="{{ chat.store.photo_url }}" alt="{{ chat.store.name }}" class="w-10 h-10 rounded-full">
                    <div>
                        <h3 class="font-semibold text-gray-800">{{ chat.store.name }}</h3>
                        <p class="text-gray-500 text-sm">Last message at {{ chat.last_message_time }}</p>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- No Chats Message -->
    {% if chats|length == 0 %}
    <div id="noChatsMessage" class="text-center text-gray-600 mt-8">
        No chats. Start a chat with your favorite merchant!
    </div>
    {% endif %}
</div>

<!-- Modal for Adding Chat (Initially Hidden) -->
<div id="addChatModal" class="fixed inset-0 bg-gray-800 bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-lg p-6 relative shadow-lg">
        <h3 class="text-2xl font-bold mb-4 text-gray-800">Start a Chat!</h3>
        <input type="text" id="searchStores" placeholder="Search stores" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <div id="storeList" class="space-y-2 max-h-60 overflow-y-auto">
            <!-- Store list populated here via AJAX -->
        </div>
        <button onclick="closeAddChatModal()" class="absolute top-5 right-5 bg-secondary text-black rounded-full w-8 h-8 flex items-center justify-center">âœ•</button>
    </div>
</div>

<!-- Confirmation Dialog for Deleting Chat -->
<div id="deleteChatModal" class="fixed inset-0 bg-gray-800 bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-md p-6 text-center">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Delete Chat?</h3>
        <p class="text-gray-600 mb-6">Are you sure you want to delete this chat?</p>
        <div class="flex justify-center space-x-4">
            <button onclick="confirmDeleteChat()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
            <button onclick="closeDeleteChatModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">
  let selectedChatId = null;
  let pressTimer;

  // Show delete confirmation on right-click or long press
  function showDeleteOption(event, chatId) {
    event.preventDefault();
    selectedChatId = chatId;
    $('#deleteChatModal').removeClass('hidden');
  }

  function startLongPress(event, chatId) {
    pressTimer = setTimeout(function() {
      showDeleteOption(event, chatId);
    }, 700);  // 700 ms for long press
  }

  // Cancel long press if touch ends or moves
  document.addEventListener("touchend", function() {
    clearTimeout(pressTimer);
  });
  document.addEventListener("touchmove", function() {
    clearTimeout(pressTimer);
  });

  // Function to confirm delete
  function confirmDeleteChat() {
    if (selectedChatId) {
      $.ajax({
        url: `/chats/api/chats/${selectedChatId}/delete/`,  // The URL endpoint to delete chat
        type: 'POST',
        data: {
          chat_id: selectedChatId,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.success) {
            $(`[data-chat-id="${selectedChatId}"]`).remove();  // Remove the chat item from the DOM
            closeDeleteChatModal();
            if ($('#chatList').children().length === 0) {
              $('#noChatsMessage').show();
            }
          } else {
            console.log("Error deleting chat:", response.error);
          }
        },
        error: function(xhr, errmsg, err) {
          console.log("AJAX error deleting chat:", errmsg);
        }
      });
    }
  }

  // Function to close delete chat modal
  function closeDeleteChatModal() {
    $('#deleteChatModal').addClass('hidden');
    selectedChatId = null;
  }

  // Function to show the add chat modal
  function openAddChatModal() {
    $('#addChatModal').removeClass('hidden');
  }

  // Function to close the add chat modal
  function closeAddChatModal() {
    $('#addChatModal').addClass('hidden');
  }
</script>

{% endblock content %}
